import moment from 'moment-timezone';
import { prepareWAMessageMedia, generateWAMessageFromContent } from "@whiskeysockets/baileys";

// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ù„Ø­Ø¯ÙˆØ¯ (Ø³ØªÙƒÙˆÙ† Ù…Ù†ÙØµÙ„Ø© Ù„ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© ÙˆÙƒÙ„ Ø£Ù…Ø±)
let usageLimits = {};

// Handler Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø£Ù…Ø±
let handler = async (m, { isOwner, isAdmin, conn, text, participants, args, command }) => {
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ø¯Ù‚Ø© (Ù…Ø¹ throw Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ†ÙÙŠØ° Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±)
  if (!(isAdmin || isOwner)) {
    global.dfail('admin', m, conn);
    throw false; // ÙŠØ¶Ù…Ù† Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ†ÙÙŠØ° ØªÙ…Ø§Ù…Ù‹Ø§
  }

  let groupId = m.chat;
  let senderId = m.sender;

  // ØªØµØ­ÙŠØ­ usageKey Ù„ÙŠÙƒÙˆÙ† Ù…Ù†ÙØµÙ„Ù‹Ø§ Ù„ÙƒÙ„ Ø£Ù…Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø¯Ø¹Ù… Ø­Ø¯ Ù…Ø³ØªÙ‚Ù„ Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ù…Ù†Ø´Ù†)
  let usageKey = `${groupId}:${command}`;

  // Ø£Ù…Ø± ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ (Ù„Ù„Ù…Ø·ÙˆØ± ÙÙ‚Ø·ØŒ ÙˆÙŠÙ…ÙƒÙ† ØªØ¹ÙŠÙŠÙ† Ø­Ø¯ Ù…Ø®ØªÙ„Ù Ù„ÙƒÙ„ Ø£Ù…Ø± Ø¥Ø°Ø§ Ø£Ø±ÙŠØ¯ Ù„Ø§Ø­Ù‚Ù‹Ø§)
  if (command === 'ØªØ­Ø¯ÙŠØ¯_Ù…Ù†Ø´Ù†') {
    if (!isOwner) {
      m.reply('âŒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø·ÙˆØ±.');
      return;
    }
    let limit = parseInt(args[0]);
    if (isNaN(limit) || limit <= 0) {
      m.reply('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ ÙƒØ­Ø¯ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….');
      return;
    }
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…ØŒ Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ† ØªØ®ØµÙŠØµÙ‡ Ù„ÙƒÙ„ command Ø¥Ø°Ø§ Ø£Ø¶ÙÙ†Ø§ args Ø¥Ø¶Ø§ÙÙŠØ©
    usageLimits[groupId] = limit;
    m.reply(`âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ù†Ø´Ù† Ø¥Ù„Ù‰ ${limit} Ù…Ø±Ø© (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ®ØµÙŠØµ Ù„ÙƒÙ„ Ø£Ù…Ø±).`);
    return;
  }

  // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù…Ù†Ø´Ù† (Ù…Ø­Ø³Ù‘Ù†Ø© Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø¥ØµØ¯Ø§Ø±Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
  if (command === 'Ù…Ù†Ø´Ù†') {
    const coverImageUrl = 'https://files.catbox.moe/ziws8j.jpg';
    const messa = await prepareWAMessageMedia(
      { image: { url: coverImageUrl } },
      { upload: conn.waUploadToServer }
    );

    const interactiveMessage = {
      body: { text: "âœ¨ *Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø´Ù† Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯Ù‡:*" },
      footer: { text: "ğ™°ğšğšƒ_ğ™±ğ™¾ğšƒ" },
      header: {
        title: "â•­â”€â”€â”€âŸ¢â² ğ™°ğšğšƒ_ğ™±ğ™¾ğšƒ â³â•°â”€â”€â”€âŸ¢",
        hasMediaAttachment: true,
        imageMessage: messa.imageMessage,
      },
      nativeFlowMessage: {
        buttons: [
          {
            name: 'single_select',
            buttonParamsJson: JSON.stringify({
              title: "âœ¨ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø´Ù†",
              sections: [
                {
                  title: "ï½¢ğŸ„â”ŠØ§Ù„Ù€ÙƒÙ€Ù„â”ŠğŸ„ï½£",
                  rows: [
                    {
                      header: "ï½¢ğŸ„â”ŠÙ…Ù†Ø´Ù†_Ø§Ù„ÙƒÙ„â”ŠğŸ„ï½£",
                      title: "*â§ˆâ”€â•¼â”â•¾â•¼â”â”‡â€¢â„ï¸â€¢â”‡â”â•¾â”€â•¼â•¾â”€â§ˆ*",
                      description: "ï½¢âš¡â”Šğ™°ğšğšƒ_ğ™±ğ™¾ğšƒâ”Šâš¡ï½£",
                      id: ".Ù…Ù†Ø´Ù†_Ø§Ù„ÙƒÙ„"
                    }
                  ]
                },
                {
                  title: "ï½¢ğŸ„â”ŠØ§Ø¹Ù€Ø¶Ù€Ø§Ø¡â”ŠğŸ„ï½£",
                  rows: [
                    {
                      header: "ï½¢ğŸ„â”ŠÙ…Ù†Ø´Ù†_Ø§Ø¹Ø¶Ø§Ø¡â”ŠğŸ„ï½£",
                      title: "*â§ˆâ”€â•¼â”â•¾â•¼â”â”‡â€¢â„ï¸â€¢â”‡â”â•¾â”€â•¼â•¾â”€â§ˆ*",
                      description: "ï½¢âš¡â”Šğ™°ğšğšƒ_ğ™±ğ™¾ğšƒâ”Šâš¡ï½£",
                      id: ".Ù…Ù†Ø´Ù†_Ø§Ø¹Ø¶Ø§Ø¡"
                    }
                  ]
                },
                {
                  title: "ï½¢ğŸ„â”ŠØ§Ù„Ù…Ø´Ø±ÙÙŠÙ†â”ŠğŸ„ï½£",
                  rows: [
                    {
                      header: "ï½¢ğŸ„â”ŠÙ…Ù†Ø´Ù†_Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†â”ŠğŸ„ï½£",
                      title: "*â§ˆâ”€â•¼â”â•¾â•¼â”â”‡â€¢â„ï¸â€¢â”‡â”â•¾â”€â•¼â•¾â”€â§ˆ*",
                      description: "ï½¢âš¡â”Šğ™°ğšğšƒ_ğ™±ğ™¾ğšƒâ”Šâš¡ï½£",
                      id: ".Ù…Ù†Ø´Ù†_Ù…Ø´Ø±ÙÙŠÙ†"
                    }
                  ]
                },
                {
                  title: "ï½¢ğŸ„â”ŠÙ…Ø®ÙÙŠâ”ŠğŸ„ï½£",
                  rows: [
                    {
                      header: "ï½¢ğŸ„â”ŠÙ…Ù†Ø´Ù†_Ù…Ø®ÙÙŠâ”ŠğŸ„ï½£",
                      title: "*â§ˆâ”€â•¼â”â•¾â•¼â”â”‡â€¢â„ï¸â€¢â”‡â”â•¾â”€â•¼â•¾â”€â§ˆ*",
                      description: "ï½¢âš¡â”Šğ™°ğšğšƒ_ğ™±ğ™¾ğšƒâ”Šâš¡ï½£",
                      id: ".Ù…Ø®ÙÙŠ"
                    }
                  ]
                }
              ]
            })
          }
        ],
        messageParamsJson: ''
      }
    };

    let msg = generateWAMessageFromContent(m.chat, {
      viewOnceMessage: {
        message: {
          interactiveMessage,
        },
      },
    }, { userJid: conn.user.jid, quoted: m });
    conn.relayMessage(m.chat, msg.message, { messageId: msg.key.id });
    return;
  }

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ø¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ (Ø­Ø¯ Ø¹Ø§Ù… Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŒ Ù„ÙƒÙ† usageKey Ù…Ù†ÙØµÙ„ Ù„ÙƒÙ„ command)
  if (!usageLimits[groupId]) usageLimits[groupId] = 3; // Ø­Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ 3
  if (usageLimits[usageKey] === undefined) usageLimits[usageKey] = usageLimits[groupId];

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ù…Ù†ÙØµÙ„ Ù„ÙƒÙ„ Ø£Ù…Ø±)
  if (usageLimits[usageKey] <= 0) {
    m.reply('âŒ ØªÙ… Ø§Ø³ØªÙ†ÙØ§Ø¯ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†.');
    return;
  }

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª (Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø¨ØµÙŠØºØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ø³Ø¬Ù„Ø§Øª)
  let pesan = args.join` `;
  let time = moment.tz('Asia/Riyadh').format('hh:mm A');
  let date = moment.tz('Asia/Riyadh').format('YYYY/MM/DD');
  // Ø§Ø³ØªØ®Ø¯Ø§Ù… m.chat ÙƒÙ€ groupNameØŒ Ù„ÙƒÙ† Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø§Ø³ØªØ®Ø¯Ù… await conn.getName (Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¨Ø·Ø¡ Ø¹Ø¨Ø± ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ø¥Ø°Ø§ Ø£Ù…ÙƒÙ†)
  let groupName = await conn.getName(m.chat); // Ø£ÙØ¶Ù„ Ù„Ù„Ø¹Ø±Ø¶ØŒ ÙˆØ§Ù„Ø¨Ø·Ø¡ Ø¶Ø¦ÙŠÙ„ ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ØµØºÙŠØ±Ø©

  // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙˆØ¹ (Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…Ù†Ø¸Ù…Ø©)
  let filteredParticipants =
    command === 'Ù…Ù†Ø´Ù†_Ø§Ø¹Ø¶Ø§Ø¡'
      ? participants.filter(p => !p.admin)
      : command === 'Ù…Ù†Ø´Ù†_Ù…Ø´Ø±ÙÙŠÙ†'
      ? participants.filter(p => p.admin)
      : participants;

  // Ø²Ø®Ø±ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ù…Ø­Ø³Ù‘Ù†Ø© ÙˆÙ…ØªÙ†Ø§Ø³Ù‚Ø© Ù…Ø¹ ØªÙ†Ø¸ÙŠÙ… Ø£ÙØ¶Ù„)
  let teks = `
â”€âŸ¢Ù€*
> Ë¼âš•ï¸Ë¹â†œ ${command === 'Ù…Ù†Ø´Ù†_Ø§Ø¹Ø¶Ø§Ø¡' ? 'ğŸŒŸ *Ù‚Ù€Ù€Ø³Ù€Ù€Ù… Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†*' : command === 'Ù…Ù†Ø´Ù†_Ù…Ø´Ø±ÙÙŠÙ†' ? 'ğŸ‘‘ *Ù‚Ù€Ù€Ø³Ù€Ù€Ù… Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†*' : 'ğŸŒŸ *Ù‚Ù€Ù€Ø³Ù€Ù€Ù… Ø¬Ù…ÙŠØ¹ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©*'} â†¶
â•®â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âŸ¢Ù€

ğŸ’  *Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:* ã€ ${groupName} ã€
ğŸ“… *Ø§Ù„ØªØ§Ø±ÙŠØ®:* ã€ ${date} ã€
ğŸ•°ï¸ *Ø§Ù„ÙˆÙ‚Øª:* ã€ ${time} ã€
ğŸ‘¥ *Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙÙŠÙ†:* ã€ ${filteredParticipants.length} ã€

> Ë¼âš•ï¸Ë¹â†œ ğŸ·ï¸ *Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡* â†¶
â•®â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âŸ¢Ù€
${filteredParticipants.map(mem => `â”ŠâŸ£ï½¢@${mem.id.split('@')[0]}ï½£`).join('\n')}
â•¯â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âŸ¢Ù€

> Ë¼âš•ï¸Ë¹â†œ ğŸ‘‘ *Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…Ù†Ø´Ù†* â†¶
â•®â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âŸ¢Ù€
â”ŠâŸ£ï½¢@${m.sender.split('@')[0]}ï½£
â•¯â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âŸ¢Ù€

> Ë¼âš•ï¸Ë¹â†œ ğŸ¤– *ØªØ­ÙŠØ§Øªâ‡‡ ğ™°ğšğšƒ_ğ™±ğ™¾ğšƒ* â†¶
`;

  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ mentions Ø¯Ù‚ÙŠÙ‚Ø© (Ø§Ø³ØªØ®Ø¯Ø§Ù… Set Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±)
  const uniqueMentions = [...new Set(filteredParticipants.map(a => a.id).concat([m.sender]))];

  conn.sendMessage(m.chat, {
    text: teks,
    mentions: uniqueMentions,
    image: { url: 'https://qu.ax/nrLHp.jpg' }
  });

  // Ø®ØµÙ… Ù…Ù† Ø§Ù„Ø­Ø¯ (Ù…Ù†ÙØµÙ„ Ù„ÙƒÙ„ Ø£Ù…Ø±)
  usageLimits[usageKey] -= 1;
};

// ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ø£Ù…Ø± (Ù…Ø¹ Ø¯Ø¹Ù… Ù…Ø®ÙÙŠ Ø¥Ø°Ø§ Ø£Ø±ÙŠØ¯)
handler.help = ['Ù…Ù†Ø´Ù†_Ø§Ø¹Ø¶Ø§Ø¡ <message>', 'Ù…Ù†Ø´Ù†_Ù…Ø´Ø±ÙÙŠÙ† <message>', 'Ù…Ù†Ø´Ù†_Ø§Ù„ÙƒÙ„ <message>', 'ØªØ­Ø¯ÙŠØ¯_Ù…Ù†Ø´Ù† <Ø¹Ø¯Ø¯>', 'Ù…Ù†Ø´Ù†'];
handler.tags = ['group'];
handler.command = /^(Ù…Ù†Ø´Ù†_Ø§Ø¹Ø¶Ø§Ø¡|Ù…Ù†Ø´Ù†_Ù…Ø´Ø±ÙÙŠÙ†|Ù…Ù†Ø´Ù†_Ø§Ù„ÙƒÙ„|ØªØ­Ø¯ÙŠØ¯_Ù…Ù†Ø´Ù†|Ù…Ù†Ø´Ù†)$/i;
handler.admin = true;
handler.group = true;

export default handler;